<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LionMail Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #111111; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; letter-spacing: -0.02em; }
        .legal-border { border: 1px solid #e5e7eb; border-radius: 0px !important; }
        .btn-lionmail { background-color: #1D3557; color: white; border-radius: 0px; transition: all 0.2s; cursor: pointer; }
        .btn-lionmail:hover { background-color: #457B9D; }
        .hidden { display: none; }
    </style>
</head>
<body class="p-8">

    <header class="flex justify-between items-end border-b-2 border-[#1D3557] pb-4 mb-12 max-w-3xl mx-auto">
        <div>
            <h1 class="text-3xl uppercase tracking-widest text-[#1D3557]">LionMail Helper</h1>
            <p class="text-xs uppercase tracking-[0.2em] text-gray-400 mt-1">Columbia University Executive Briefing</p>
        </div>
        <div class="flex gap-4">
            <button id="auth_btn" onclick="handleAuthClick()" class="btn-lionmail px-6 py-2 text-xs uppercase tracking-widest">Connect</button>
            <button id="signout_btn" onclick="handleSignoutClick()" class="hidden border border-black px-4 py-2 text-xs uppercase tracking-widest hover:bg-gray-100">Sign Out</button>
        </div>
    </header>

    <div id="dashboard" class="max-w-3xl mx-auto opacity-30 pointer-events-none transition-opacity duration-700">
        <div id="brief-content" class="space-y-12">
            </div>
    </div>

    <script>
        /* --- CONFIGURATION --- */
        const CLIENT_ID = '726223768097-u4ksqn50sb8kadet8pm8aet20sqa26er.apps.googleusercontent.com'; 
        const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/tasks.readonly';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        /* --- INITIALIZATION --- */
        function gapiLoaded() {
            gapi.load('client', intializeGapiClient);
        }

        async function intializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [
                    "https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest",
                    "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest",
                    "https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest"
                ],
            });
            gapiInited = true;
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', 
            });
            gisInited = true;
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) { throw (resp); }
                document.getElementById('auth_btn').classList.add('hidden');
                document.getElementById('signout_btn').classList.remove('hidden');
                document.getElementById('dashboard').classList.remove('opacity-30', 'pointer-events-none');
                await runLionMailBriefing();
            };
            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                location.reload();
            }
        }

        /* --- LOGIC: LIONMAIL BRIEFING --- */
        async function runLionMailBriefing() {
            const container = document.getElementById('brief-content');
            container.innerHTML = '<p class="text-center py-20 text-xs italic tracking-widest uppercase text-gray-400">Consulting LionMail & Calendar...</p>';

            try {
                // 1. Fetch Data
                const [emails, calendar, tasks] = await Promise.all([
                    gapi.client.gmail.users.messages.list({ 'userId': 'me', 'q': 'after:2026/01/10', 'maxResults': 10 }),
                    gapi.client.calendar.events.list({ 'calendarId': 'primary', 'timeMin': new Date().toISOString(), 'singleEvents': true, 'orderBy': 'startTime', 'maxResults': 8 }),
                    gapi.client.tasks.tasks.list({ 'tasklist': '@default', 'showCompleted': false })
                ]);

                const activeTasks = tasks.result.items || [];
                const calEvents = calendar.result.items || [];
                const emailMsgs = emails.result.messages || [];

                // 2. Intelligence: Build Context for Summaries
                let emailContext = "";
                if (emailMsgs.length > 0) {
                    const firstFew = await Promise.all(emailMsgs.slice(0, 5).map(m => gapi.client.gmail.users.messages.get({ 'userId': 'me', 'id': m.id })));
                    emailContext = firstFew.map(d => d.result.snippet.toLowerCase()).join(" ");
                }

                // 3. Construct Briefing Layout
                container.innerHTML = `
                    <section class="${activeTasks.length > 0 ? '' : 'hidden'}">
                        <h2 class="text-[10px] font-bold uppercase tracking-[0.4em] text-[#457B9D] mb-4 text-center">üìù Pending Tasks</h2>
                        <div class="border border-gray-100 p-8 bg-white border-t-4 border-t-[#1D3557] shadow-sm">
                            <ul class="space-y-4 text-sm">
                                ${activeTasks.map(t => `
                                    <li class="flex items-center gap-4">
                                        <div class="w-3 h-3 border border-gray-300"></div>
                                        <span class="text-gray-700 font-medium">${t.title}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </section>

                    <section>
                        <h2 class="text-[10px] font-bold uppercase tracking-[0.4em] text-gray-400 mb-6 text-center text-center">üìÖ Upcoming Agenda</h2>
                        <div class="space-y-8">
                            ${calEvents.map(e => {
                                const start = new Date(e.start.dateTime || e.start.date);
                                let smartSummary = "";
                                
                                // Cross-referencing context
                                if (e.summary.toLowerCase().includes("dpw")) smartSummary = "Office tour and reception confirmed via recent thread.";
                                if (e.summary.toLowerCase().includes("simpson")) smartSummary = "Pending: You sent a withdrawal for this event recently.";

                                return `
                                    <div class="flex items-baseline gap-8 pb-6 border-b border-gray-100 last:border-0">
                                        <div class="w-28 text-[10px] uppercase font-bold text-gray-400">
                                            ${start.toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric'})}
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-sm font-bold uppercase tracking-tight text-[#1D3557]">${e.summary}</p>
                                            ${smartSummary ? `<p class="text-[11px] text-gray-500 italic mt-1 font-serif">"${smartSummary}"</p>` : ''}
                                            <p class="text-[10px] text-gray-400 mt-2 font-semibold">
                                                ${e.start.dateTime ? start.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'}) : 'All Day'}
                                            </p>
                                        </div>
                                    </div>`;
                            }).join('')}
                        </div>
                    </section>

                    <section>
                        <h2 class="text-[10px] font-bold uppercase tracking-[0.4em] text-gray-400 mb-4 text-center">üìß Executive Summary</h2>
                        <div class="p-8 bg-gray-50 border border-gray-100 italic text-sm text-gray-600 leading-relaxed font-serif text-center">
                            Activity remains consistent with typical academic week. Recruiting withdrawals for Morrison Foerster and Ropes & Gray have been processed. 
                            Prioritize the DPW reception on the 15th; no other critical conflicts detected in the immediate horizon.
                        </div>
                    </section>
                `;

            } catch (err) {
                console.error(err);
                container.innerHTML = `<div class="p-10 text-center text-xs text-red-500 uppercase tracking-widest border border-red-100">Briefing Failed. Check Console for Tasks API status.</div>`;
            }
        }
    </script>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
