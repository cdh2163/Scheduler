<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LionMail Helper v5.1</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fcfcfc; color: #111111; }
        h1, h2 { font-family: 'Playfair Display', serif; }
        .paul-weiss-container { background-color: #ffffff; border-left: 5px solid #1D3557; padding: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .audit-box { border: 1px dashed #e2e8f0; background-color: #f8fafc; padding: 1.2rem; margin-bottom: 0.75rem; transition: transform 0.2s; }
        .audit-box:hover { transform: scale(1.01); }
        .prose strong { color: #1D3557; font-weight: 700; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-6 md:p-12">

    <header class="flex justify-between items-end border-b-2 border-[#1D3557] pb-6 mb-12 max-w-4xl mx-auto">
        <div>
            <h1 class="text-4xl uppercase tracking-tighter text-[#1D3557]">LionMail Helper</h1>
            <p class="text-[10px] uppercase tracking-[0.4em] text-gray-400 mt-2 font-bold italic">Full-Spectrum Auditor â€¢ v5.1</p>
        </div>
        <div class="flex items-center gap-6">
            <button onclick="localStorage.clear(); location.reload();" class="text-[9px] uppercase tracking-widest text-gray-300 hover:text-red-600">Reset System</button>
            <button id="refresh_btn" onclick="runLionMailBriefing()" class="hidden p-2 text-[#1D3557] border border-gray-200 hover:bg-white transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            </button>
            <button id="auth_btn" onclick="handleAuthClick()" class="bg-[#1D3557] text-white px-8 py-3 text-[10px] uppercase font-bold tracking-widest">Connect</button>
        </div>
    </header>

    <main id="dashboard" class="max-w-4xl mx-auto opacity-10 pointer-events-none transition-all duration-700">
        <div id="brief-content" class="space-y-12"></div>
    </main>

    <script>
        const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/tasks.readonly';
        let tokenClient;

        function getStoredKey(k, p) {
            let v = localStorage.getItem(k);
            if (!v) { v = prompt(p); if (v) localStorage.setItem(k, v.trim()); }
            return v;
        }

        async function getAIResponse(prompt) {
            const apiKey = getStoredKey('GEMINI_API_KEY', "Enter Gemini Key:");
            const listUrl = `https://generativelanguage.googleapis.com/v1/models?key=${apiKey}`;
            const listData = await (await fetch(listUrl)).json();
            const model = (listData.models || []).find(m => m.supportedGenerationMethods.includes("generateContent") && m.name.includes("flash"))?.name || "models/gemini-1.5-flash";
            
            const genUrl = `https://generativelanguage.googleapis.com/v1/${model}:generateContent?key=${apiKey}`;
            const res = await fetch(genUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        }

        function gapiLoaded() { gapi.load('client', () => gapi.client.init({ discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest", "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest", "https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest"] })); }
        function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: getStoredKey('GCP_CLIENT_ID', "Enter Client ID:"), scope: SCOPES, callback: '' }); }
        
        function handleAuthClick() { 
            tokenClient.callback = async (r) => {
                document.getElementById('auth_btn').classList.add('hidden');
                document.getElementById('refresh_btn').classList.remove('hidden');
                document.getElementById('dashboard').classList.remove('opacity-10', 'pointer-events-none');
                runLionMailBriefing();
            };
            tokenClient.requestAccessToken({ prompt: 'select_account' });
        }

        async function runLionMailBriefing() {
                const container = document.getElementById('brief-content');
                container.innerHTML = `<p class="text-center py-20 text-xs italic tracking-widest text-gray-400 animate-pulse">Consulting the Chief of Staff...</p>`;
        
                try {
                    const now = new Date();
                    
                    const [inbox, calendar, tasks, scheduled] = await Promise.all([
                        gapi.client.gmail.users.messages.list({ userId: 'me', q: 'is:unread label:inbox' }),
                        gapi.client.calendar.events.list({ 
                            calendarId: 'primary', 
                            timeMin: now.toISOString(), 
                            singleEvents: true, 
                            orderBy: 'startTime',
                            maxResults: 30 
                        }),
                        gapi.client.tasks.tasks.list({ tasklist: '@default', showCompleted: true, showHidden: true }),
                        gapi.client.gmail.users.messages.list({ userId: 'me', q: 'label:scheduled' })
                    ]);
        
                    // 1. DATA PREP: Filter Ghost Tasks
                    const allTasks = tasks.result.items || [];
                    const completedTitles = allTasks.filter(t => t.status === 'completed').map(t => t.title.toLowerCase().trim());
        
                    // 2. CONTEXT BUNDLING: Create the "Situation Report"
                    let calendarContext = "CALENDAR EVENTS (with times/locations):\n";
                    const processedEvents = (calendar.result.items || []).filter(e => {
                        const title = e.summary.toLowerCase().trim();
                        return !completedTitles.includes(title);
                    }).map(e => {
                        const start = e.start.dateTime || e.start.date;
                        const end = e.end.dateTime || e.end.date;
                        const loc = e.location || "No location listed";
                        return `- ${e.summary}: ${new Date(start).toLocaleString()} to ${new Date(end).toLocaleTimeString()} at ${loc}`;
                    });
                    calendarContext += processedEvents.join('\n');
        
                    let emailContext = "RECENT UNREAD EMAILS:\n";
                    if (inbox.result.messages) {
                        const details = await Promise.all(inbox.result.messages.slice(0, 8).map(m => gapi.client.gmail.users.messages.get({ userId: 'me', id: m.id })));
                        emailContext += details.map(d => {
                            const subj = d.result.payload.headers.find(h => h.name === 'Subject').value;
                            const from = d.result.payload.headers.find(h => h.name === 'From').value;
                            return `- FROM: ${from} | SUBJ: ${subj} | CONTENT: ${d.result.snippet}`;
                        }).join('\n');
                    }
        
                    // 3. THE "ZAPIER-STYLE" AI PROMPT
                    const aiPrompt = `
                        You are Christopher's Executive Chief of Staff. Review the data below and provide a Daily Summary.
                        
                        STYLE REQUIREMENTS:
                        - Use the exact format of Christopher's previous Zapier agent.
                        - Sections: ðŸ“§ Recent Email Activity, ðŸ“… Today's Calendar Events, âš ï¸ SCHEDULING CONFLICT DETECTED, ðŸ“‹ Action Items.
                        - Use ðŸ”´ for High Priority items found in emails.
                        - CRITICAL: Analyze start times and end times. If events overlap OR if an email invitation conflicts with a calendar event, explain the conflict clearly using the ðŸš¨ emoji.
                        
                        DATA:
                        ${calendarContext}
                        
                        ${emailContext}
                    `;
        
                    const aiResponse = await getAIResponse(aiPrompt);
        
                    // 4. CALENDAR VIEW LOGIC (Next 24h OR 6 events)
                    const tomorrow = new Date(now.getTime() + (24 * 60 * 60 * 1000));
                    const filteredEvents = (calendar.result.items || []).filter(e => !completedTitles.includes(e.summary.toLowerCase().trim()));
                    const next24h = filteredEvents.filter(e => new Date(e.start.dateTime || e.start.date) <= tomorrow);
                    const displayEvents = next24h.length >= 6 ? next24h : filteredEvents.slice(0, 6);
        
                    // 5. RENDER
                    container.innerHTML = `
                        <section class="animate-fade-in">
                            <div class="paul-weiss-container prose prose-sm max-w-none">
                                ${marked.parse(aiResponse)}
                            </div>
                        </section>
        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-12 mt-12">
                            <section>
                                <h2 class="text-[10px] font-bold uppercase tracking-[0.4em] text-gray-400 mb-6 border-b pb-2">Verified Schedule</h2>
                                <div class="space-y-4">
                                    ${displayEvents.map(e => `
                                        <div class="flex justify-between items-center">
                                            <div class="flex flex-col">
                                                <span class="text-[8px] font-bold text-gray-400 uppercase">${new Date(e.start.dateTime || e.start.date).toLocaleDateString([], {month:'short', day:'numeric'})}</span>
                                                <span class="text-[9px] text-gray-400">${e.start.dateTime ? new Date(e.start.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'All Day'}</span>
                                            </div>
                                            <div class="text-right">
                                                <p class="font-semibold text-sm text-[#1D3557]">${e.summary}</p>
                                                <p class="text-[9px] text-gray-400">${e.location || ''}</p>
                                            </div>
                                        </div>`).join('')}
                                </div>
                            </section>
                            <section>
                                <h2 class="text-[10px] font-bold uppercase tracking-[0.4em] text-gray-400 mb-6 border-b pb-2">Unfinished Tasks</h2>
                                <div class="space-y-2">
                                    ${allTasks.filter(t => t.status !== 'completed').map(t => `<div class="p-3 bg-white border border-gray-100 text-[10px] font-medium text-gray-700">${t.title}</div>`).join('')}
                                </div>
                            </section>
                        </div>
                    `;
                } catch (err) { console.error(err); }
            }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
