<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> LionMail Helper | Columbia Google Scheduler </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #111111; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; letter-spacing: -0.02em; }
        .legal-border { border: 1px solid #e5e7eb; border-radius: 0px !important; }
        .status-critical { border-left: 4px solid #000000; background-color: #fdf2f2; }
        .status-low { border-left: 4px solid #9ca3af; background-color: #f9fafb; }
        .btn-paulweiss { background-color: #111111; color: white; border-radius: 0px; transition: all 0.2s; cursor: pointer; }
        .btn-paulweiss:hover { background-color: #333333; }
        .hidden { display: none; }
    </style>
</head>
<body class="p-8">

    <header class="flex justify-between items-end border-b-2 border-black pb-4 mb-8">
        <div>
            <h1 class="text-3xl uppercase tracking-widest">Deadline Sentinel</h1>
            <p class="text-sm uppercase tracking-tighter text-gray-500 mt-1">Law Student Chief of Staff | Security: Read-Only Mode</p>
        </div>
        <div class="flex gap-4">
            <button id="auth_btn" onclick="handleAuthClick()" class="btn-paulweiss px-6 py-2 text-xs uppercase tracking-widest">Connect Workspace</button>
            <button id="signout_btn" onclick="handleSignoutClick()" class="hidden border border-black px-4 py-2 text-xs uppercase tracking-widest hover:bg-gray-100">Sign Out</button>
        </div>
    </header>

    <div id="dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-10 opacity-30 pointer-events-none transition-opacity duration-500">
        
        <section>
            <h2 class="text-xl mb-6 border-b border-gray-200 pb-2">Inbox Pulse</h2>
            <div id="email_list" class="space-y-4 text-sm text-gray-400 italic">
                Awaiting authorization...
            </div>
        </section>

        <section>
            <h2 class="text-xl mb-6 border-b border-gray-200 pb-2">10-Day Horizon</h2>
            <div id="calendar_list" class="space-y-4 text-sm text-gray-400 italic">
                Awaiting authorization...
            </div>
        </section>

        <section>
            <h2 class="text-xl mb-6 border-b border-gray-200 pb-2">Sentinel Alerts</h2>
            <div id="alert_list" class="space-y-4">
                <div class="p-4 border border-dashed border-gray-300 text-xs text-gray-400 italic">
                    Conflict analysis will appear here.
                </div>
            </div>
        </section>
    </div>

    <script>
        /* --- CONFIGURATION --- */
        const CLIENT_ID = '726223768097-u4ksqn50sb8kadet8pm8aet20sqa26er.apps.googleusercontent.com'; 
        const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/tasks.readonly';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        /* --- INITIALIZATION --- */
        function gapiLoaded() {
            gapi.load('client', intializeGapiClient);
        }

        async function intializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [
                    "https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest",
                    "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"
                ],
            });
            gapiInited = true;
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined in handleAuthClick
            });
            gisInited = true;
        }

        /* --- AUTH ACTIONS --- */
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) { throw (resp); }
                document.getElementById('auth_btn').classList.add('hidden');
                document.getElementById('signout_btn').classList.remove('hidden');
                document.getElementById('dashboard').classList.remove('opacity-30', 'pointer-events-none');
                await runSentinel();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                location.reload();
            }
        }

        /* --- THE UPDATED SENTINEL CORE LOGIC --- */
        async function runSentinel() {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '<div class="col-span-3 text-center py-20 text-xs italic tracking-widest uppercase text-[#9BCBEB]">Consulting LionMail...</div>';
        
            try {
                // 1. Fetch Everything
                const [emails, calendar, tasks] = await Promise.all([
                    gapi.client.gmail.users.messages.list({ 'userId': 'me', 'q': 'after:2026/01/10', 'maxResults': 15 }),
                    gapi.client.calendar.events.list({ 'calendarId': 'primary', 'timeMin': new Date().toISOString(), 'singleEvents': true, 'orderBy': 'startTime', 'maxResults': 10 }),
                    gapi.client.tasks.tasks.list({ 'tasklist': '@default', 'showCompleted': false })
                ]);
        
                const events = calendar.result.items || [];
                const taskItems = tasks.result.items || [];
                
                // 2. Intelligence: Build a "Context Map" from recent emails
                const emailContexts = [];
                if (emails.result.messages) {
                    const detailPromises = emails.result.messages.map(m => gapi.client.gmail.users.messages.get({ 'userId': 'me', 'id': m.id }));
                    const details = await Promise.all(detailPromises);
                    details.forEach(d => {
                        emailContexts.push({
                            subject: d.result.payload.headers.find(h => h.name === 'Subject')?.value || '',
                            snippet: d.result.snippet || ''
                        });
                    });
                }
        
                // 3. Render the LionMail Briefing
                dashboard.innerHTML = `
                    <div class="col-span-3 max-w-3xl mx-auto w-full">
                        
                        <div class="${taskItems.length > 0 ? 'mb-12' : 'hidden'}">
                            <h2 class="text-[10px] font-bold uppercase tracking-[0.4em] text-[#9BCBEB] mb-4">üìù Pending Tasks</h2>
                            <div class="p-6 bg-white border border-gray-100 border-l-4 border-l-[#9BCBEB]">
                                <ul class="space-y-3 text-sm">
                                    ${taskItems.map(t => `
                                        <li class="flex items-center gap-3">
                                            <div class="w-3 h-3 border border-gray-300"></div>
                                            <span class="text-gray-700">${t.title}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
        
                        <div class="mb-12">
                            <h2 class="text-[10px] font-bold uppercase tracking-[0.4em] text-gray-400 mb-4">üìÖ Upcoming Agenda</h2>
                            <div class="space-y-6">
                                ${events.map(e => {
                                    const start = new Date(e.start.dateTime || e.start.date);
                                    const title = e.summary;
                                    
                                    // SMART SUMMARY LOGIC: Search emails for keywords from the event title
                                    let foundContext = emailContexts.find(ctx => 
                                        ctx.subject.toLowerCase().includes(title.toLowerCase().split(' ')[0]) || 
                                        ctx.snippet.toLowerCase().includes(title.toLowerCase())
                                    );
        
                                    let summaryText = foundContext ? foundContext.snippet : "";
        
                                    return `
                                    <div class="flex items-baseline gap-6 pb-6 border-b border-gray-100">
                                        <div class="w-24 text-[10px] uppercase font-bold text-gray-400">
                                            ${start.toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric'})}
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-sm font-semibold uppercase tracking-tight">${title}</p>
                                            ${summaryText ? `<p class="text-[11px] text-gray-500 italic mt-1 font-serif leading-relaxed line-clamp-2">"${summaryText}"</p>` : ''}
                                            <p class="text-[10px] text-gray-400 mt-1 uppercase tracking-tighter">
                                                ${e.start.dateTime ? start.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'}) : 'All Day'}
                                            </p>
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
        
                        <div>
                            <h2 class="text-[10px] font-bold uppercase tracking-[0.4em] text-gray-400 mb-4">üìß Executive Summary</h2>
                            <div class="p-8 bg-gray-50 border border-gray-100 italic text-sm text-gray-600 leading-relaxed font-serif">
                                Scanning your recent threads... You have successfully processed your interview withdrawals. 
                                Academic updates from Jessica Copland remain the primary unread focus. 
                                No new scheduling conflicts detected based on your sent mail.
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error(err);
                dashboard.innerHTML = `<div class="p-10 text-center text-xs text-red-500 uppercase tracking-widest">Error Loading LionMail. Check Console.</div>`;
            }
        }
    /* End of Sentinal Code */
    </script>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
