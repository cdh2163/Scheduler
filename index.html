<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LionMail Helper v5.1</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fcfcfc; color: #111111; }
        h1, h2 { font-family: 'Playfair Display', serif; }
        .paul-weiss-container { background-color: #ffffff; border-left: 5px solid #1D3557; padding: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .audit-box { border: 1px dashed #e2e8f0; background-color: #f8fafc; padding: 1.2rem; margin-bottom: 0.75rem; transition: transform 0.2s; }
        .audit-box:hover { transform: scale(1.01); }
        .prose strong { color: #1D3557; font-weight: 700; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-6 md:p-12">

    <header class="flex justify-between items-end border-b-2 border-[#1D3557] pb-6 mb-12 max-w-4xl mx-auto">
        <div>
            <h1 class="text-4xl uppercase tracking-tighter text-[#1D3557]">LionMail Helper</h1>
            <p class="text-[10px] uppercase tracking-[0.4em] text-gray-400 mt-2 font-bold italic">Full-Spectrum Auditor ‚Ä¢ v5.1</p>
        </div>
        <div class="flex items-center gap-6">
            <button onclick="localStorage.clear(); location.reload();" class="text-[9px] uppercase tracking-widest text-gray-300 hover:text-red-600">Reset System</button>
            <button id="refresh_btn" onclick="runLionMailBriefing()" class="hidden p-2 text-[#1D3557] border border-gray-200 hover:bg-white transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            </button>
            <button id="auth_btn" onclick="handleAuthClick()" class="bg-[#1D3557] text-white px-8 py-3 text-[10px] uppercase font-bold tracking-widest">Connect</button>
        </div>
    </header>

    <main id="dashboard" class="max-w-4xl mx-auto opacity-10 pointer-events-none transition-all duration-700">
        <div id="brief-content" class="space-y-12"></div>
    </main>

    <script>
        const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/tasks.readonly';
        let tokenClient;

        function getStoredKey(k, p) {
            let v = localStorage.getItem(k);
            if (!v) { v = prompt(p); if (v) localStorage.setItem(k, v.trim()); }
            return v;
        }

        async function getAIResponse(prompt) {
            const apiKey = getStoredKey('GEMINI_API_KEY', "Enter Gemini Key:");
            const listUrl = `https://generativelanguage.googleapis.com/v1/models?key=${apiKey}`;
            const listData = await (await fetch(listUrl)).json();
            const model = (listData.models || []).find(m => m.supportedGenerationMethods.includes("generateContent") && m.name.includes("flash"))?.name || "models/gemini-1.5-flash";
            
            const genUrl = `https://generativelanguage.googleapis.com/v1/${model}:generateContent?key=${apiKey}`;
            const res = await fetch(genUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        }

        function gapiLoaded() { gapi.load('client', () => gapi.client.init({ discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest", "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest", "https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest"] })); }
        function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: getStoredKey('GCP_CLIENT_ID', "Enter Client ID:"), scope: SCOPES, callback: '' }); }
        
        function handleAuthClick() { 
            tokenClient.callback = async (r) => {
                document.getElementById('auth_btn').classList.add('hidden');
                document.getElementById('refresh_btn').classList.remove('hidden');
                document.getElementById('dashboard').classList.remove('opacity-10', 'pointer-events-none');
                runLionMailBriefing();
            };
            tokenClient.requestAccessToken({ prompt: 'select_account' });
        }

        async function runLionMailBriefing() {
            const container = document.getElementById('brief-content');
            container.innerHTML = `<p class="text-center py-20 text-xs italic tracking-widest text-gray-400 animate-pulse">Scanning Full Spectrum...</p>`;

            try {
                const now = new Date();
                const [inbox, calendar, tasks, scheduled] = await Promise.all([
                    gapi.client.gmail.users.messages.list({ userId: 'me', q: 'is:unread label:inbox' }),
                    gapi.client.calendar.events.list({ calendarId: 'primary', timeMin: now.toISOString(), singleEvents: true, orderBy: 'startTime', maxResults: 15 }),
                    gapi.client.tasks.tasks.list({ tasklist: '@default', showCompleted: false }),
                    gapi.client.gmail.users.messages.list({ userId: 'me', q: 'label:scheduled' })
                ]);

                // 1. DATA PREP
                let inboxText = (inbox.result.messages || []).length > 0 ? "EMAILS:\n" : "NO NEW EMAILS";
                if (inbox.result.messages) {
                    const details = await Promise.all(inbox.result.messages.slice(0, 5).map(m => gapi.client.gmail.users.messages.get({ userId: 'me', id: m.id })));
                    inboxText += details.map(d => `- From: ${d.result.payload.headers.find(h=>h.name==='From').value} | Subj: ${d.result.payload.headers.find(h=>h.name==='Subject').value} | Snippet: ${d.result.snippet}`).join("\n");
                }

                const calArray = (calendar.result.items || []).map(e => `${e.summary} on ${e.start.dateTime || e.start.date}`);
                const calText = "\n\nCALENDAR:\n" + calArray.join('\n');

                // 2. MAIN BRIEFING (With Overlap Check)
                const mainBriefPrompt = `You are a Law School Chief of Staff. Summarize these emails and calendar events for Christopher. 
                STYLE: Paul Weiss Executive, Use Emojis.
                CRITICAL: If an email mentions an event date/time that conflicts with a calendar event, flag it immediately with üö® CONFLICT.
                CONTEXT:\n${inboxText}${calText}`;
                const aiBrief = await getAIResponse(mainBriefPrompt);

                // 3. SCHEDULED AUDIT
                let scheduledAuditHtml = "";
                if (scheduled.result.messages) {
                    scheduledAuditHtml = `<section class="animate-fade-in"><h2 class="text-[10px] font-bold uppercase tracking-[0.4em] text-gray-400 mb-4">Scheduled Outreach Quality Control</h2><div class="grid grid-cols-1 gap-2">`;
                    const details = await Promise.all(scheduled.result.messages.map(m => gapi.client.gmail.users.messages.get({ userId: 'me', id: m.id })));
                    
                    for (let msg of details) {
                        const to = msg.result.payload.headers.find(h => h.name === 'To')?.value || "Unknown";
                        const body = msg.result.snippet;
                        const audit = await getAIResponse(`Audit this scheduled email for Christopher. Output ONLY 1 sentence starting with a check or x. Check for typos and wrong firm names. To: ${to} | Body: ${body}`);
                        const isError = audit.includes('‚ùå') || audit.toLowerCase().includes('typo') || audit.toLowerCase().includes('wrong');
                        
                        scheduledAuditHtml += `
                            <div class="audit-box flex justify-between items-center border ${isError ? 'border-red-200 bg-red-50' : 'border-gray-100 bg-white'}">
                                <div class="text-[11px] leading-tight flex-1 pr-4">
                                    <span class="font-bold text-[#1D3557]">To: ${to}</span> ‚Äî <span class="text-gray-600">${audit}</span>
                                </div>
                                <span class="text-sm font-bold">${isError ? 'üö®' : '‚úÖ'}</span>
                            </div>`;
                    }
                    scheduledAuditHtml += `</div></section>`;
                }

                // RENDER
                container.innerHTML = `
                    <section class="animate-fade-in">
                        <h2 class="text-[10px] font-bold uppercase tracking-[0.4em] text-gray-400 mb-4 text-center">Executive Intelligence</h2>
                        <div class="paul-weiss-container prose prose-sm max-w-none">${marked.parse(aiBrief)}</div>
                    </section>

                    ${scheduledAuditHtml}

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                        <section>
                            <h2 class="text-[10px] font-bold uppercase tracking-[0.4em] text-gray-400 mb-6 border-b pb-2">Verified Schedule</h2>
                            <div class="space-y-4">
                                ${(calendar.result.items || []).map(e => `
                                    <div class="flex justify-between items-center">
                                        <div class="flex flex-col">
                                            <span class="text-[8px] font-bold text-gray-400 uppercase">${new Date(e.start.dateTime || e.start.date).toLocaleDateString([], {weekday: 'short', month:'short', day:'numeric'})}</span>
                                            <span class="text-[9px] text-gray-400">${e.start.dateTime ? new Date(e.start.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'All Day'}</span>
                                        </div>
                                        <span class="font-semibold text-sm text-[#1D3557] text-right">${e.summary}</span>
                                    </div>`).join('')}
                            </div>
                        </section>
                        <section>
                            <h2 class="text-[10px] font-bold uppercase tracking-[0.4em] text-gray-400 mb-6 border-b pb-2">Pending Matters</h2>
                            <div class="space-y-3">
                                ${(tasks.result.items || []).map(t => `<div class="p-3 bg-white border border-gray-100 text-[11px] font-medium text-gray-700 flex items-center gap-3"><div class="w-1 h-1 bg-gray-400"></div>${t.title}</div>`).join('')}
                            </div>
                        </section>
                    </div>
                `;
            } catch (err) { console.error(err); container.innerHTML = `<p class="text-red-500 text-center uppercase tracking-widest text-[10px] font-bold">Audit Failure: Check Google Console</p>`; }
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
